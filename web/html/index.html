{{define "title"}}Goverview{{end}}

{{define "content"}}
<!-- Start of new content  -->
<div class="row">
  <!-- Jumbotron  -->
  <div class="col-md-12">
    <div class="jumbotron jumbotron-fluid" style="background-color: #212121;color: white;padding: 25px">
      <div class="container">
        <h2 class="bg-dark" style="padding:5px;display:inline-block;">
          Goverview
        </h2>
      </div>
    </div>
  </div>
  <!-- End Jumbotron -->
</div>

<div class="row row-cols-4 index-container">
  {{ range $val := .}}
    {{ if not $val.Runs }}
    {{else}}
      {{ range $run := $val.Runs }}
      <div class="col repo-card">
        <div class="card run-{{ $run.WorkflowID }}">
          <div class="card-body">
            <div class="card-title">
              <h4 class="bg-dark repo-information">
                {{$val.Repository}} <span class="text-secondary">#{{ $run.RunNumber }}</span>
              </h4>
            </div>
            <div class="card-text">
              <div class="event-information">
                {{ if $run.Conclusion }}
                <span class="badge {{ $run.Conclusion | colorCase }}"><i class="bi {{$run.Conclusion | iconCase}}" style="color:white;"></i>{{ $run.Conclusion }}</span>
                {{ else }}
                <span class="badge {{ $run.Status | colorCase }}"><i class="bi {{$run.Status | iconCase}}" style="color:white;"></i> {{ $run.Status }}</span>
                {{ end }}
                <span class="badge bg-primary">{{ $run.Event }}</span>
                <a href="/workflow/{{ $run.Repository.Name }}/{{ $run.ID }}">View Action</a>
              </div>
              <div class="time-information">
                <span class="text-muted">{{ $run.CreatedAt | timeAgo }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      {{end}}
    {{end}}
    
  {{ end }}
</div>

<script>
connect();

function connect() {
    const websocket = new WebSocket("ws://localhost:8080/ws?path=index");
    websocket.open = function(event) {
      console.log("Successfully connected to websocket server");
    };

    websocket.onerror = function(error) {
      console.error("Error connecting to websocket server: ", error);
    };

    websocket.onmessage = function(event) {
      console.log(event.data);
      runs = JSON.parse(event.data);
      updateRuns(runs);
    };
}


function updateRuns(runs) {
    let lastRunId = (runs[0].Runs[0].id) ? runs[0].Runs[0].id : 0;
    
    $.each(runs, function(index, item) {
        let icon = (item.Runs[0].status) ? item.Runs[0].status : item.Runs[0].conclusion;
        console.log(item.Runs, item.Runs[0].workflow_id);

        if ($(`.card.job-${item.Runs[0].workflow_id}`).length > 0) {
            $(`.card.job-${item.Runs[0].workflow_id}.card-body.card-text.event-information`).replaceWith(`<div class="event-information"><span class="badge ${getIcon(icon)}"><i class="bi ${getIcon(icon)}">${icon}</i></span><span class="badge bg-primary">push</span><a href="/workflow/${item.Repository}/${item.Runs[0].id}">View Action</a></div>`);
            $(`.card.job-${item.Runs[0].workflow_id}.card-body.card-text.time-information`).replaceWith(`<div class="time-information"><span class="text-muted">${timeAgo(item.Runs[0].created_at)}</span></div>`);
        }
    });
}
</script>
{{end}}
